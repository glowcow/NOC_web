stages:
  - build
  - test
  - cleanup
  - push

variables:
  DOCKER_TLS_CERTDIR: ""

Build Image:
  stage: build
  tags:
    - noc_msk
    - docker
  tags:
    - noc_msk
    - docker
  script:
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG.$CI_PIPELINE_ID .

Test with docker-compose:
  stage: test
  tags:
    - noc_msk
    - docker
  image:
    name: docker/compose:1.29.2
    entrypoint: [""]
  script:
    - docker-compose
      -p "$CI_PROJECT_NAME"_"$CI_PIPELINE_ID"
      up
      --abort-on-container-exit
      --exit-code-from test
      --quiet-pull

Cleanup test:
  stage: cleanup
  tags:
    - noc_msk
    - docker
  image:
    name: docker/compose:1.29.2
    entrypoint: [""]
  script:
    - docker-compose -p "$CI_PROJECT_NAME"_"$CI_PIPELINE_ID" down
  when: always

Push image to registry:
  stage: push
  tags:
    - noc_msk
    - docker
  before_script:
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY
  script:
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME:$CI_COMMIT_REF_SLUG.$CI_PIPELINE_ID
  only:
    - master